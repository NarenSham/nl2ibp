<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OptiGuide Chatbot</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    #scenario-indicator {
      display: none;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #ffeb3b;
      color: #333;
      font-weight: bold;
      border-radius: 4px;
      text-align: center;
    }
    #scenario-buttons {
      margin-bottom: 10px;
    }
    button {
      margin-right: 8px;
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>OptiGuide Chatbot</h2>

  <div id="scenario-indicator">⚠️ Scenario Mode Active</div>
  <div id="scenario-buttons">
    <button id="start-scenario-btn">Start Scenario</button>
    <button id="save-scenario-btn" disabled>Save Scenario</button>
  </div>

  <div id="container">
    <div id="left-panel">
      <div id="visualization">
        <h3>Visualization</h3>
        <div class="placeholder">Map or Chart will appear here</div>
      </div>
      <div id="json-output">
        <h3>Raw JSON Output</h3>
        <table id="json-table"></table>
        <pre id="json-raw"></pre>
      </div>
    </div>

    <div id="right-panel">
      <div id="chatbox"></div>
      <input type="text" id="user-input" placeholder="Ask me anything..." />
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const jsonTable = document.getElementById('json-table');
    const jsonRaw = document.getElementById('json-raw');

    const startScenarioBtn = document.getElementById('start-scenario-btn');
    const saveScenarioBtn = document.getElementById('save-scenario-btn');
    const scenarioIndicator = document.getElementById('scenario-indicator');

    let scenarioActive = false;
    let activeScenarioId = null;

    function appendMessage(message, className) {
      const msgDiv = document.createElement('div');
      msgDiv.className = className;
      msgDiv.textContent = message;
      chatbox.appendChild(msgDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function clearJsonDisplay() {
      jsonTable.innerHTML = '';
      jsonRaw.textContent = '';
    }

    function renderJsonTable(data) {
      if (!data) return;
      clearJsonDisplay();

      if (Array.isArray(data)) {
        if (data.length === 0) {
          jsonRaw.textContent = 'Empty array';
          return;
        }
        const headers = Object.keys(data[0]);
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        jsonTable.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.forEach(item => {
          const row = document.createElement('tr');
          headers.forEach(h => {
            const td = document.createElement('td');
            td.textContent = item[h];
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
        jsonTable.appendChild(tbody);

      } else if (typeof data === 'object') {
        const tbody = document.createElement('tbody');
        Object.entries(data).forEach(([key, value]) => {
          const row = document.createElement('tr');
          const keyTd = document.createElement('td');
          keyTd.textContent = key;
          const valTd = document.createElement('td');
          valTd.textContent = JSON.stringify(value);
          row.appendChild(keyTd);
          row.appendChild(valTd);
          tbody.appendChild(row);
        });
        jsonTable.appendChild(tbody);

      } else {
        jsonRaw.textContent = JSON.stringify(data, null, 2);
      }
    }

    async function sendQuery() {
      const query = userInput.value.trim();
      if (!query) return;
      appendMessage(`You: ${query}`, 'user-msg');
      userInput.value = '';

      clearJsonDisplay();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        });
        const data = await res.json();

        if (data.error) {
          appendMessage(`Bot: ${data.error}`, 'bot-msg');
        } else {
          appendMessage(`Bot: ${data.nlg}`, 'bot-msg');
          renderJsonTable(data.response);
        }
      } catch (err) {
        appendMessage(`Bot: Error occurred: ${err}`, 'bot-msg');
      }
    }

    sendBtn.addEventListener('click', sendQuery);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendQuery();
    });

    // Scenario buttons handlers
    startScenarioBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/scenario/start', { method: 'POST' });
        const data = await res.json();
        if (data.status === 'started') {
          scenarioActive = true;
          activeScenarioId = data.scenario_id;
          scenarioIndicator.style.display = 'block';
          saveScenarioBtn.disabled = false;
          appendMessage("System: Scenario mode started.", 'system-msg');
        }
      } catch (err) {
        appendMessage(`System: Failed to start scenario mode: ${err}`, 'system-msg');
      }
    });

    saveScenarioBtn.addEventListener('click', async () => {
      if (!scenarioActive || !activeScenarioId) {
        appendMessage("System: No active scenario to save.", "system-msg");
        return;
      }

      // TODO: Replace with actual override data from UI/input
      const overrides = [
        {
          table_name: "retailers",
          row_id: 1,
          column_name: "demand",
          override_value: "120"
        }
      ];

      try {
        const res = await fetch('/api/scenario/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scenario_id: activeScenarioId, overrides }),
        });

        const data = await res.json();

        if (res.ok && data.status === 'saved') {
          appendMessage("System: Scenario saved successfully.", 'system-msg');
        } else {
          appendMessage(`System: Failed to save scenario: ${data.error || 'Unknown error'}`, 'system-msg');
        }
      } catch (err) {
        appendMessage(`System: Failed to save scenario: ${err}`, 'system-msg');
      }
    });
  </script>
</body>
</html>
